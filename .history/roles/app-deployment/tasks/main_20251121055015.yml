
---
- name: Ensure git is installed
  apt:
    name: git
    state: present

- name: Remove existing application directory if exists
  file:
    path: "{{ app_directory }}"
    state: absent
  when: git_force_clone | default(false)
  tags: ['never', 'force-clone']

- name: Clone application repository
  git:
    repo: "{{ git_repo }}"
    dest: "{{ app_directory }}"
    version: "{{ git_branch }}"
    force: yes
    accept_hostkey: yes
  become_user: root
  environment:
    GIT_SSH_COMMAND: "ssh -i {{ git_deploy_key_path }} -o StrictHostKeyChecking=no"
  when: vault_git_deploy_key is defined

- name: Set ownership of application directory
  file:
    path: "{{ app_directory }}"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    recurse: yes

- name: Copy environment-specific secrets
  copy:
    src: "{{ playbook_dir }}/secrets/{{ environment }}.env"
    dest: "{{ app_directory }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0600'

- name: Install npm dependencies
  npm:
    path: "{{ app_directory }}"
    state: present
  become_user: "{{ app_user }}"

- name: Build React application (if needed)
  command: npm run build
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ app_user }}"
  environment:
    NODE_ENV: "{{ environment }}"
  when: environment == 'production'
  ignore_errors: yes

- name: Stop existing PM2 process
  command: pm2 delete {{ pm2_app_name }}
  become_user: "{{ app_user }}"
  ignore_errors: yes
  changed_when: false

- name: Start application with PM2
  command: pm2 start npm --name {{ pm2_app_name }} -- start
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ app_user }}"
  environment:
    NODE_ENV: "{{ environment }}"
    PORT: "{{ app_port }}"

- name: Save PM2 process list
  command: pm2 save
  become_user: "{{ app_user }}"

- name: Generate PM2 startup script
  command: pm2 startup systemd -u {{ app_user }} --hp /home/{{ app_user }}
  register: pm2_startup_output
  changed_when: false

- name: Execute PM2 startup command
  shell: "{{ pm2_startup_output.stdout_lines | last }}"
  when: pm2_startup_output.stdout_lines | length > 0
  ignore_errors: yes

- name: Display PM2 status
  command: pm2 list
  become_user: "{{ app_user }}"
  register: pm2_status
  changed_when: false

- name: Show PM2 processes
  debug:
    var: pm2_status.stdout_lines
